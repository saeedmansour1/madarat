<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>عارض سجلات الحضور - نسخة نهائية</title>

<!-- SheetJS لقراءة Excel محليًا -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#0f172a; --card:#0b1220; --accent:#06b6d4; --muted:#94a3b8; --glass:rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Segoe UI", Tahoma, Arial;background:linear-gradient(180deg,#021028 0%, #031a2b 60%);color:#e6eef6}
.container{max-width:1200px;margin:24px auto;padding:18px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#8b5cf6);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021;box-shadow:0 6px 18px rgba(6,182,212,.12)}
.hgroup h1{margin:0;font-size:18px}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px}
.input-file{background:var(--glass);border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;cursor:pointer}
.select-month{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
.btn{background:linear-gradient(90deg,var(--accent),#8b5cf6);border:none;padding:9px 12px;border-radius:8px;color:#012;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
.meta{margin-top:12px;color:var(--muted);font-size:13px}
.reports{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:12px;margin-top:14px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
.table-wrap{overflow:auto;max-height:480px}
table{width:100%;border-collapse:collapse;font-size:13px;color:#dbeafe}
th,td{padding:6px 8px;text-align:center;border:1px solid rgba(255,255,255,0.03)}
th{position:sticky;top:0;background:rgba(0,0,0,0.15);backdrop-filter:blur(6px)}
.empty{padding:22px;border:2px dashed rgba(255,255,255,0.03);border-radius:10px;text-align:center;color:var(--muted)}
.footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}

/* ===== طباعة مخصصة ===== */
@media print{
  body, .container { background:#fff; color:#000; }
  .controls, .footer, .btn, .input-file, .select-month { display:none !important; }
}

/* الصفحة الأولى (كشف الأسماء) مضغوطة */
.print-first-page{padding:12px 8px 6px;text-align:right}
.print-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:11px}
.print-table th,.print-table td{border:1px solid #333;padding:4px 6px;text-align:center;font-size:10px}

/* جدول كل موظف مضغوط */
.emp-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:11px}
.emp-table th,.emp-table td{border:1px solid #333;padding:4px;text-align:center;font-size:10px}

/* فاصل الصفحة لكل موظف */
.employee-section{page-break-after:always;margin-top:12px;padding-top:6px;border-top:1px dashed #ccc}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo">س</div>
      <div class="hgroup">
        <h1>عارض سجلات الحضور لريان الجور</h1>
        <div class="small">قراءة Excel محليًا - كشف أسماء مضغوط + صفحات موظفين</div>
      </div>
    </div>
    <div class="small">نسخة احترافية</div>
  </div>

  <div class="controls">
    <label class="input-file" onclick="document.getElementById('fileInput').click()">اختر ملف Excel
      <input id="fileInput" type="file" accept=".xls,.xlsx" style="display:none" onchange="handleExcelFile(event)">
    </label>

    <button class="btn ghost" onclick="downloadDisplayedCSV()">تحميل CSV</button>
    <button class="btn" onclick="printAllEmployeesStyled()">طباعة الكشف + صفحات الموظفين</button>
  </div>

  <div id="metaInfo" class="meta">لم يتم رفع ملف بعد.</div>

  <div id="reports" class="reports">
    <div class="empty">لم يتم تحميل بيانات بعد.</div>
  </div>

  <div class="footer">تطبيق محلي — لا حاجة لسيرفر م/سعيد مهتدى</div>
</div>

<script>
/* حالة التطبيق */
const state = {
  raw: [],
  grouped: {},   // grouped[id][date] = [times...]
  months: new Set(),
  names: {},
  allDates: new Set() // جميع التواريخ الموجودة في الملف
};

/* قراءة ملف Excel */
function handleExcelFile(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const data = new Uint8Array(ev.target.result);
    const wb = XLSX.read(data, { type: 'array' });
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
    processExcelData(json);
  };
  reader.readAsArrayBuffer(file);
}

/* محاولة فك تشفير الأسماء (windows-1256 fallback) */
function decodePossiblyCP1256(text){
  if(!text) return '';
  text = String(text);
  // إذا يحتوي على عربي بالفعل
  if(/[\u0600-\u06FF]/.test(text)) return text;
  // حاول TextDecoder windows-1256
  try{
    if(typeof TextDecoder === 'function'){
      const decoder = new TextDecoder('windows-1256');
      const bytes = new Uint8Array(text.split('').map(ch => ch.charCodeAt(0) & 0xFF));
      const dec = decoder.decode(bytes);
      if(/[ء-ي]/.test(dec)) return dec;
    }
  }catch(e){}
  // محاولة بديلة: Latin1 -> UTF-8 trick
  try{
    const conv = decodeURIComponent(escape(text));
    if(/[ء-ي]/.test(conv)) return conv;
  }catch(e){}
  // fallback: أصل النص
  return text;
}

/* تحويل Excel serial date إلى YYYY-MM-DD */
function excelSerialToDate(serial){
  const n = Number(serial);
  if(isNaN(n)) return serial;
  // Excel's serial starts 1 Jan 1900 but with bug: 1900 is leap in Excel.
  const epoch = new Date(Date.UTC(1899,11,30));
  epoch.setUTCDate(epoch.getUTCDate() + n);
  const y = epoch.getUTCFullYear();
  const m = String(epoch.getUTCMonth()+1).padStart(2,'0');
  const d = String(epoch.getUTCDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

/* تنظيف وتنسيق الوقت وتحويل الأحرف الغريبة إلى AM/PM */
function cleanAndFormatTime(timeStr) {
  if (!timeStr) return '';
  
  // تحويل إلى نص
  let cleaned = String(timeStr).trim();
  
  // إذا كان فارغاً
  if (!cleaned) return '';

  // تحويل الأحرف الغريبة إلى AM/PM
  if (cleaned.includes('ã') || cleaned.includes('Ã') || cleaned.includes('ã'.charCodeAt(0))) {
    // الحرف ã يمثل وقت مسائي (PM)
    cleaned = cleaned.replace(/[ãÃ]/g, 'PM');
  }
  
  if (cleaned.includes('Õ') || cleaned.includes('Õ'.charCodeAt(0)) || cleaned.includes('õ')) {
    // الحرف Õ يمثل وقت صباحي (AM)
    cleaned = cleaned.replace(/[Õõ]/g, 'AM');
  }

  // إزالة أي أحرف غريبة متبقية وتحويل الوقت
  cleaned = cleaned.replace(/[^0-9:.\sAPMapm]/g, '').trim();
  
  // إذا كان الوقت يحتوي على AM/PM (تنسيق 12 ساعة)
  if (cleaned.match(/[APap][Mm]/)) {
    // تحويل من 12 ساعة إلى 24 ساعة
    const timeParts = cleaned.split(/:|\s/);
    let hours = parseInt(timeParts[0]);
    const minutes = timeParts[1] || '00';
    const period = cleaned.toUpperCase().includes('PM') ? 'PM' : 'AM';
    
    if (period === 'PM' && hours < 12) {
      hours += 12;
    } else if (period === 'AM' && hours === 12) {
      hours = 0;
    }
    
    return `${String(hours).padStart(2, '0')}:${minutes.padStart(2, '0')}`;
  }
  
  // إذا كان الوقت بتنسيق 24 ساعة بالفعل
  if (cleaned.match(/^\d{1,2}:\d{2}$/)) {
    const [h, m] = cleaned.split(':');
    return `${String(h).padStart(2, '0')}:${m.padStart(2, '0')}`;
  }
  
  // إذا كان الوقت برقم عشري (مثل 0.5 لـ 12:00)
  if (cleaned.match(/^\d+\.\d+$/)) {
    const decimal = parseFloat(cleaned);
    const totalMinutes = Math.round(decimal * 24 * 60);
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
  }
  
  return cleaned;
}

/* معالجة بيانات الإكسل */
function processExcelData(data){
  state.raw = data;
  state.grouped = {};
  state.months = new Set();
  state.names = {};
  state.allDates = new Set();

  // نتوقع أن الصف الأول رأس
  for(let i=1;i<data.length;i++){
    const row = data[i];
    if(!row || row.length < 4) continue;

    const rawName = typeof row[1] !== 'undefined' ? row[1] : '';
    const name = decodePossiblyCP1256(rawName).trim();
    const id = row[2] !== undefined ? String(row[2]).trim() : '';
    let dateTime = row[3] !== undefined ? String(row[3]).trim() : '';
    if(!id || !dateTime) continue;

    // تفصيل التاريخ والوقت
    let datePart = '';
    let timePart = '';

    // لو التاريخ مكتوب كـ Excel serial (رقم)
    if(/^\d+(\.\d+)?$/.test(dateTime) && dateTime.length < 6){
      // قد يكون serial أو وقت فقط - نعالج لاحقًا
      datePart = excelSerialToDate(dateTime.split('.')[0]);
    } else {
      const parts = dateTime.split(' ');
      if(parts.length >= 1){
        datePart = parts[0];
        timePart = parts.slice(1).join(' ');
      }
      // إذا التاريخ بصيغة d/m/Y
      if(datePart.indexOf('/') !== -1){
        const dp = datePart.split('/');
        if(dp.length === 3){
          let day = dp[0].padStart(2,'0');
          let month = dp[1].padStart(2,'0');
          let year = dp[2];
          if(year.length === 2) year = '20' + year;
          datePart = `${year}-${month}-${day}`;
        }
      } else if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(datePart)){
        // صحيح الشكل
      } else {
        // محاولة تحويل لو كان serial داخل cell مع وقت منفصل
        const n = Number(datePart);
        if(!isNaN(n)) datePart = excelSerialToDate(n);
      }
    }

    // تنظيف وتنسيق الوقت
    timePart = cleanAndFormatTime(timePart);

    // تخزين الاسم
    if(name && !state.names[id]) state.names[id] = name;

    // تجميع
    if(!state.grouped[id]) state.grouped[id] = {};
    const dayKey = datePart.length >= 10 ? datePart.slice(0,10) : datePart;
    if(!state.grouped[id][dayKey]) state.grouped[id][dayKey] = [];
    if(timePart && !state.grouped[id][dayKey].includes(timePart)) state.grouped[id][dayKey].push(timePart);

    // إضافة تواريخ
    if(dayKey && dayKey.length >= 10) {
      state.allDates.add(dayKey);
      state.months.add(dayKey.slice(0,7));
    }
  }

  // ترتيب الأوقات لكل يوم
  for(const id of Object.keys(state.grouped)){
    for(const d of Object.keys(state.grouped[id])){
      state.grouped[id][d].sort();
    }
  }

  document.getElementById('metaInfo').textContent = `تم قراءة ${Math.max(0, state.raw.length - 1)} سجل، و${Object.keys(state.grouped).length} موظف، ${state.allDates.size} يوم.`;

  // عرض جميع البيانات مباشرة
  renderAllData();
}

/* تحويل تاريخ YYYY-MM-DD إلى اسم يوم عربي */
function getArabicWeekday(dateStr){
  if(!dateStr) return '';
  const p = dateStr.split('-');
  if(p.length < 3) return '';
  const d = new Date(Number(p[0]), Number(p[1])-1, Number(p[2]));
  const days = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];
  return days[d.getDay()];
}

/* عرض جميع البيانات بدون تصفية */
function renderAllData(){
  const reports = document.getElementById('reports');
  reports.innerHTML = '';
  const ids = Object.keys(state.grouped).sort((a,b)=>Number(a)-Number(b));
  
  if(ids.length === 0){
    reports.innerHTML = '<div class="empty">لا توجد سجلات للعرض.</div>';
    return;
  }

  // الحصول على جميع التواريخ وترتيبها
  const allDates = Array.from(state.allDates).sort();
  
  ids.forEach(id => {
    const card = document.createElement('div');
    card.className = 'card';
    const name = state.names[id] || `الموظف ${id}`;
    const header = document.createElement('div');
    header.innerHTML = `<h3 style="margin:0 0 6px">${escapeHtml(name)}</h3><div class="small">الرقم: ${escapeHtml(id)} — ${allDates.length} يوم</div>`;
    card.appendChild(header);

    const wrap = document.createElement('div'); wrap.className = 'table-wrap';
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = `<tr><th>مسلسل</th><th>التاريخ</th><th>اليوم</th><th>الزمن 1</th><th>الزمن 2</th><th>الزمن 3</th><th>الزمن 4</th><th>الزمن 5</th></tr>`;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    allDates.forEach((date, index) => {
      const times = state.grouped[id][date] || [];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${index + 1}</td>
                      <td>${date}</td>
                      <td>${getArabicWeekday(date)}</td>
                      <td>${escapeHtml(times[0]||'-')}</td>
                      <td>${escapeHtml(times[1]||'-')}</td>
                      <td>${escapeHtml(times[2]||'-')}</td>
                      <td>${escapeHtml(times[3]||'-')}</td>
                      <td>${escapeHtml(times[4]||'-')}</td>`;
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    wrap.appendChild(table);
    card.appendChild(wrap);
    reports.appendChild(card);
  });
}

/* تنزيل CSV */
function downloadDisplayedCSV(){
  const ids = Object.keys(state.grouped).sort((a,b)=>Number(a)-Number(b));
  const allDates = Array.from(state.allDates).sort();
  
  if(ids.length === 0) return alert('لا توجد بيانات للتحميل');
  
  const rows = [['ID','Name','Date','Day','Time1','Time2','Time3','Time4','Time5']];
  ids.forEach(id => {
    const name = state.names[id] || '';
    allDates.forEach(date => {
      const times = state.grouped[id][date] || [];
      rows.push([id, name, date, getArabicWeekday(date), times[0]||'', times[1]||'', times[2]||'', times[3]||'', times[4]||'']);
    });
  });
  
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); 
  a.href = url; 
  a.download = `attendance_all_data.csv`; 
  document.body.appendChild(a); 
  a.click(); 
  a.remove(); 
  URL.revokeObjectURL(url);
}

/* طباعة: الصفحة الأولى كشف أسماء منسق مضغوط + لكل موظف صفحة منفصلة */
function printAllEmployeesStyled(){
  const ids = Object.keys(state.grouped).sort((a,b)=>Number(a)-Number(b));
  const allDates = Array.from(state.allDates).sort();
  
  if(!ids.length) return alert('لا توجد بيانات للطباعة');

  let html = `<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>طباعة سجلات الحضور</title>
    <style>
      body{font-family:Arial, Tahoma; color:#222; padding:18px}
      .company{display:flex;justify-content:space-between;align-items:center}
      h1{margin:0}
      .first-table{width:100%;border-collapse:collapse;margin-top:12px}
      .first-table th,.first-table td{border:1px solid #333;padding:4px 6px;text-align:center;font-size:10px}
      .employee{page-break-after:always;margin-top:16px}
      .emp-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:10px}
      .emp-table th,.emp-table td{border:1px solid #333;padding:4px;text-align:center}
      .meta{font-size:12px;color:#333}
    </style>
    </head><body>`;

  // الصفحة الأولى: كشف الأسماء (مضغوط)
  html += `<div class="company"><div><h1>سجلات الحضور</h1><div class="meta">كشف أسماء الموظفين - ${allDates.length} يوم</div></div><div>${new Date().toLocaleString()}</div></div>`;
  html += `<table class="first-table"><thead><tr><th>مسلسل</th><th>الاسم</th><th>الرقم</th></tr></thead><tbody>`;
  ids.forEach((id, idx) => {
    html += `<tr><td>${idx+1}</td><td>${escapeHtml(state.names[id]||id)}</td><td>${escapeHtml(id)}</td></tr>`;
  });
  html += `</tbody></table><div style="page-break-after:always"></div>`;

  // صفحات الموظفين
  ids.forEach(id => {
    html += `<div class="employee"><div style="display:flex;justify-content:space-between;align-items:center"><div><h2>الموظف: ${escapeHtml(state.names[id]||id)}</h2><div class="meta">الرقم: ${escapeHtml(id)} — ${allDates.length} يوم</div></div><div>${new Date().toLocaleDateString()}</div></div>`;
    html += `<table class="emp-table"><thead><tr><th>مسلسل</th><th>التاريخ</th><th>اليوم</th><th>الزمن 1</th><th>الزمن 2</th><th>الزمن 3</th><th>الزمن 4</th><th>الزمن 5</th></tr></thead><tbody>`;
    allDates.forEach((date, index) => {
      const times = state.grouped[id][date] || [];
      html += `<tr><td>${index + 1}</td><td>${date}</td><td>${getArabicWeekday(date)}</td><td>${escapeHtml(times[0]||'-')}</td><td>${escapeHtml(times[1]||'-')}</td><td>${escapeHtml(times[2]||'-')}</td><td>${escapeHtml(times[3]||'-')}</td><td>${escapeHtml(times[4]||'-')}</td></tr>`;
    });
    html += `</tbody></table></div>`;
  });

  html += `<script>window.print();setTimeout(()=>window.close(),500);<\/script></body></html>`;

  const w = window.open('', '_blank', 'width=1200,height=800');
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* تنسيقات مساعدة */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>

</html>
