<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¹Ø§Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>

<!-- SheetJS Ù„Ù‚Ø±Ø§Ø¡Ø© Excel Ù…Ø­Ù„ÙŠÙ‹Ø§ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#0f172a; --card:#0b1220; --accent:#06b6d4; --muted:#94a3b8; --glass:rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Segoe UI", Tahoma, Arial;background:linear-gradient(180deg,#021028 0%, #031a2b 60%);color:#e6eef6}
.container{max-width:1200px;margin:24px auto;padding:18px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#8b5cf6);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021;box-shadow:0 6px 18px rgba(6,182,212,.12)}
.hgroup h1{margin:0;font-size:18px}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px}
.input-file{background:var(--glass);border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;cursor:pointer}
.select-month{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
.btn{background:linear-gradient(90deg,var(--accent),#8b5cf6);border:none;padding:9px 12px;border-radius:8px;color:#012;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
.meta{margin-top:12px;color:var(--muted);font-size:13px}
.reports{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:12px;margin-top:14px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
.table-wrap{overflow:auto;max-height:480px}
table{width:100%;border-collapse:collapse;font-size:13px;color:#dbeafe}
th,td{padding:6px 8px;text-align:center;border:1px solid rgba(255,255,255,0.03)}
th{position:sticky;top:0;background:rgba(0,0,0,0.15);backdrop-filter:blur(6px)}
.empty{padding:22px;border:2px dashed rgba(255,255,255,0.03);border-radius:10px;text-align:center;color:var(--muted)}
.footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}

/* ===== Ø·Ø¨Ø§Ø¹Ø© Ù…Ø®ØµØµØ© ===== */
@media print{
  body, .container { background:#fff; color:#000; }
  .controls, .footer, .btn, .input-file, .select-month { display:none !important; }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
  body {
    font-family: 'Arial', sans-serif;
    font-size: 12px;
    line-height: 1.4;
    margin: 0;
    padding: 10px;
  }
  
  /* ØµÙØ­Ø© ÙƒØ´Ù Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ */
  .print-first-page {
    page-break-after: always;
  }
  
  /* Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
  .employee-card {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 12px;
    margin-bottom: 15px;
    page-break-inside: avoid;
  }
  
  .employee-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid #ccc;
  }
  
  .employee-info {
    flex: 1;
  }
  
  .employee-name {
    font-size: 16px;
    font-weight: bold;
    margin: 0 0 5px 0;
    color: #000;
  }
  
  .employee-id {
    font-size: 13px;
    color: #555;
    margin: 0;
  }
  
  .employee-meta {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 8px;
  }
  
  .meta-item {
    background: white;
    border: 1px solid #eee;
    padding: 8px;
    border-radius: 3px;
    text-align: center;
  }
  
  .meta-label {
    font-size: 10px;
    color: #666;
    margin-bottom: 3px;
  }
  
  .meta-value {
    font-size: 11px;
    font-weight: bold;
    color: #333;
  }
  
  /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± */
  .attendance-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 10px;
  }
  
  .attendance-table th,
  .attendance-table td {
    border: 1px solid #333;
    padding: 4px 6px;
    text-align: center;
  }
  
  .attendance-table thead th {
    background-color: #e9ecef;
    font-weight: bold;
    color: #212529;
  }
  
  .attendance-table tbody tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  
  /* ÙØ§ØµÙ„ Ø§Ù„ØµÙØ­Ø§Øª */
  .employee-section {
    page-break-after: always;
    margin-top: 20px;
    padding-top: 15px;
  }
  
  .employee-section:first-child {
    margin-top: 0;
    padding-top: 0;
  }
  
  /* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙØ­Ø© */
  .page-info {
    font-size: 10px;
    color: #666;
    text-align: left;
    margin-top: 5px;
    border-top: 1px solid #ddd;
    padding-top: 5px;
  }
  
  /* Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨Ø© */
  @media print {
    .no-print {
      display: none !important;
    }
  }
}

/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø© */
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo">Ø³</div>
      <div class="hgroup">
        <h1>Ø¹Ø§Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ø±ÙŠØ§Ù† Ø§Ù„Ø¬ÙˆØ±</h1>
        <div class="small">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© - Ù‚Ø±Ø§Ø¡Ø© Excel Ù…Ø­Ù„ÙŠÙ‹Ø§</div>
      </div>
    </div>
    <div class="small">Ù†Ø³Ø®Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</div>
  </div>

  <div class="controls">
    <label class="input-file" onclick="document.getElementById('fileInput').click()">ğŸ“ Ø§Ø®ØªØ± Ù…Ù„Ù Excel
      <input id="fileInput" type="file" accept=".xls,.xlsx" style="display:none" onchange="handleExcelFile(event)">
    </label>

    <button class="btn ghost" onclick="downloadDisplayedCSV()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ CSV</button>
    <button class="btn" onclick="printAllEmployeesStyled()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù + ØµÙØ­Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
    <button class="btn ghost" onclick="showAllDatesTable()">ğŸ“… Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</button>
  </div>

  <div id="metaInfo" class="meta">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ù…Ù„Ù Ø¨Ø¹Ø¯.</div>
  
  <div id="allDatesTable" style="display:none; margin-bottom:20px;">
    <h3 style="text-align:center; margin-bottom:10px;">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ù…Ù„Ù</h3>
    <div id="datesTableContent"></div>
  </div>

  <div id="reports" class="reports">
    <div class="empty">Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</div>
  </div>

  <div class="footer">ØªØ·Ø¨ÙŠÙ‚ Ù…Ø­Ù„ÙŠ â€” Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø³ÙŠØ±ÙØ± | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</div>
</div>

<script>
/* Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
const state = {
  raw: [],
  grouped: {},   // grouped[id][date] = [times...]
  months: new Set(),
  names: {},
  allDates: new Set(),
  dateDayMap: {} // Ø­ÙØ¸ ØªØ®Ø·ÙŠØ· Ø§Ù„ØªØ§Ø±ÙŠØ®-Ø§Ù„ÙŠÙˆÙ…
};

/* Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel */
function handleExcelFile(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const data = new Uint8Array(ev.target.result);
    const wb = XLSX.read(data, { type: 'array' });
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
    processExcelData(json);
  };
  reader.readAsArrayBuffer(file);
}

/* ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ */
function decodePossiblyCP1256(text){
  if(!text) return '';
  text = String(text);
  if(/[\u0600-\u06FF]/.test(text)) return text;
  try{
    if(typeof TextDecoder === 'function'){
      const decoder = new TextDecoder('windows-1256');
      const bytes = new Uint8Array(text.split('').map(ch => ch.charCodeAt(0) & 0xFF));
      const dec = decoder.decode(bytes);
      if(/[Ø¡-ÙŠ]/.test(dec)) return dec;
    }
  }catch(e){}
  try{
    const conv = decodeURIComponent(escape(text));
    if(/[Ø¡-ÙŠ]/.test(conv)) return conv;
  }catch(e){}
  return text;
}

/* ØªØ­ÙˆÙŠÙ„ Excel serial date Ø¥Ù„Ù‰ YYYY-MM-DD */
function excelSerialToDate(serial){
  const n = Number(serial);
  if(isNaN(n)) return serial;
  const epoch = new Date(Date.UTC(1899,11,30));
  epoch.setUTCDate(epoch.getUTCDate() + n);
  const y = epoch.getUTCFullYear();
  const m = String(epoch.getUTCMonth()+1).padStart(2,'0');
  const d = String(epoch.getUTCDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

/* ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ ØµÙŠØºØ© dd/mm/yyyy Ù„Ù„Ø¹Ø±Ø¶ */
function formatDateDMY(dateStr) {
  if (!dateStr) return '';
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© mm/dd/yyyy
  if (dateStr.includes('/')) {
    const parts = dateStr.split('/');
    if (parts.length === 3) {
      const month = parts[0].padStart(2, '0');
      const day = parts[1].padStart(2, '0');
      let year = parts[2];
      if (year.length === 2) year = '20' + year;
      return `${day}/${month}/${year}`;
    }
  }
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© yyyy-mm-dd
  if (dateStr.includes('-')) {
    const parts = dateStr.split('-');
    if (parts.length === 3) {
      const day = parts[2].padStart(2, '0');
      const month = parts[1].padStart(2, '0');
      const year = parts[0];
      return `${day}/${month}/${year}`;
    }
  }
  
  return dateStr;
}

/* ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† mm/dd/yyyy Ø¥Ù„Ù‰ Date object */
function parseMDYToDate(dateStr) {
  if (!dateStr) return null;
  
  dateStr = dateStr.toString().trim();
  
  if (dateStr.includes('/')) {
    const parts = dateStr.split('/');
    if (parts.length === 3) {
      const month = parseInt(parts[0], 10) - 1;
      const day = parseInt(parts[1], 10);
      let year = parseInt(parts[2], 10);
      
      if (year < 100) {
        year += 2000;
      }
      
      return new Date(year, month, day, 12, 0, 0);
    }
  }
  
  return null;
}

/* ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ø§Ø³Ù… ÙŠÙˆÙ… Ø¹Ø±Ø¨ÙŠ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ */
function getArabicWeekday(dateStr){
  if(!dateStr || dateStr.trim() === '') return '';
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ†Ø§ Ø§Ù„ÙŠÙˆÙ… Ù…Ø­ÙÙˆØ¸Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹
  if (state.dateDayMap[dateStr]) {
    return state.dateDayMap[dateStr];
  }
  
  if (!dateStr.match(/\d{1,2}\/\d{1,2}\/\d{2,4}/)) {
    return '';
  }
  
  const dateObj = parseMDYToDate(dateStr);
  
  if (!dateObj || isNaN(dateObj.getTime())) {
    return '';
  }
  
  const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
  const dayIndex = dateObj.getDay();
  const dayName = days[dayIndex];
  
  // Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ… Ù„Ù„ØªØ§Ø±ÙŠØ®
  state.dateDayMap[dateStr] = dayName;
  
  return dayName;
}

/* Ø§Ø®ØªØ¨Ø§Ø± Ø£Ù† Ø§Ù„ÙŠÙˆÙ… ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® */
function testAllDates() {
  console.log('=== Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ===');
  const allDates = Array.from(state.allDates).sort();
  
  allDates.forEach(date => {
    const day = getArabicWeekday(date);
    const dateObj = parseMDYToDate(date);
    console.log(`${formatDateDMY(date)} (${date}) => ${day}`);
  });
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù…Ø¹Ø©
  const fridayDates = allDates.filter(date => getArabicWeekday(date) === 'Ø§Ù„Ø¬Ù…Ø¹Ø©');
  console.log(`Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø¬Ù…Ø¹Ø©: ${fridayDates.length}`);
  fridayDates.forEach(date => {
    console.log(`ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©: ${formatDateDMY(date)} (${date})`);
  });
}

/* ØªÙ†Ø¸ÙŠÙ ÙˆØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª */
function cleanAndFormatTime(timeStr) {
  if (!timeStr) return '';
  
  let cleaned = String(timeStr).trim();
  if (!cleaned) return '';

  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„ØºØ±ÙŠØ¨Ø© Ø¥Ù„Ù‰ AM/PM
  if (cleaned.includes('Ã£') || cleaned.includes('Ãƒ')) {
    cleaned = cleaned.replace(/[Ã£Ãƒ]/g, 'PM');
  }
  
  if (cleaned.includes('Ã•') || cleaned.includes('Ãµ')) {
    cleaned = cleaned.replace(/[Ã•Ãµ]/g, 'AM');
  }

  cleaned = cleaned.replace(/[^0-9:.\sAPMapm]/g, '').trim();
  
  if (cleaned.match(/[APap][Mm]/)) {
    const timeParts = cleaned.split(/:|\s/);
    let hours = parseInt(timeParts[0]);
    const minutes = timeParts[1] || '00';
    const period = cleaned.toUpperCase().includes('PM') ? 'PM' : 'AM';
    
    if (period === 'PM' && hours < 12) {
      hours += 12;
    } else if (period === 'AM' && hours === 12) {
      hours = 0;
    }
    
    return `${String(hours).padStart(2, '0')}:${minutes.padStart(2, '0')}`;
  }
  
  if (cleaned.match(/^\d{1,2}:\d{2}$/)) {
    const [h, m] = cleaned.split(':');
    return `${String(h).padStart(2, '0')}:${m.padStart(2, '0')}`;
  }
  
  if (cleaned.match(/^\d+\.\d+$/)) {
    const decimal = parseFloat(cleaned);
    const totalMinutes = Math.round(decimal * 24 * 60);
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
  }
  
  return cleaned;
}

/* Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„ */
function processExcelData(data){
  state.raw = data;
  state.grouped = {};
  state.months = new Set();
  state.names = {};
  state.allDates = new Set();
  state.dateDayMap = {};

  for(let i=1;i<data.length;i++){
    const row = data[i];
    if(!row || row.length < 4) continue;

    const rawName = typeof row[1] !== 'undefined' ? row[1] : '';
    const name = decodePossiblyCP1256(rawName).trim();
    const id = row[2] !== undefined ? String(row[2]).trim() : '';
    let dateTime = row[3] !== undefined ? String(row[3]).trim() : '';
    if(!id || !dateTime) continue;

    let datePart = '';
    let timePart = '';

    if(/^\d+(\.\d+)?$/.test(dateTime) && dateTime.length < 6){
      datePart = excelSerialToDate(dateTime.split('.')[0]);
    } else {
      const parts = dateTime.split(' ');
      if(parts.length >= 1){
        datePart = parts[0];
        timePart = parts.slice(1).join(' ');
      }
      
      if(datePart.indexOf('/') !== -1){
        const dp = datePart.split('/');
        if(dp.length === 3){
          let month = dp[0].padStart(2,'0');
          let day = dp[1].padStart(2,'0');
          let year = dp[2];
          if(year.length === 2) year = '20' + year;
          datePart = `${month}/${day}/${year}`;
        }
      } else if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(datePart)){
        const parts = datePart.split('-');
        datePart = `${parts[1]}/${parts[2]}/${parts[0]}`;
      } else {
        const n = Number(datePart);
        if(!isNaN(n)) {
          const serialDate = excelSerialToDate(n);
          const parts = serialDate.split('-');
          datePart = `${parts[1]}/${parts[2]}/${parts[0]}`;
        }
      }
    }

    timePart = cleanAndFormatTime(timePart);

    if(name && !state.names[id]) state.names[id] = name;

    if(!state.grouped[id]) state.grouped[id] = {};
    if(!state.grouped[id][datePart]) state.grouped[id][datePart] = [];
    if(timePart && !state.grouped[id][datePart].includes(timePart)) state.grouped[id][datePart].push(timePart);

    if(datePart && datePart.length >= 8) {
      state.allDates.add(datePart);
      const parts = datePart.split('/');
      if(parts.length === 3) {
        const monthYear = `${parts[2]}-${parts[0]}`;
        state.months.add(monthYear);
      }
    }
  }

  for(const id of Object.keys(state.grouped)){
    for(const d of Object.keys(state.grouped[id])){
      state.grouped[id][d].sort();
    }
  }

  const sortedDates = Array.from(state.allDates).sort((a, b) => {
    const dateA = parseMDYToDate(a);
    const dateB = parseMDYToDate(b);
    return dateA - dateB;
  });
  state.allDates = new Set(sortedDates);

  testAllDates();

  const totalRecords = Math.max(0, state.raw.length - 1);
  const totalEmployees = Object.keys(state.grouped).length;
  const totalDays = state.allDates.size;
  
  document.getElementById('metaInfo').innerHTML = `
    ØªÙ… Ù‚Ø±Ø§Ø¡Ø© <strong>${totalRecords}</strong> Ø³Ø¬Ù„<br>
    Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: <strong>${totalEmployees}</strong><br>
    Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…: <strong>${totalDays}</strong> ÙŠÙˆÙ…
  `;

  renderAllData();
}

/* Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
function renderAllData(){
  const reports = document.getElementById('reports');
  reports.innerHTML = '';
  const ids = Object.keys(state.grouped).sort((a,b)=>Number(a)-Number(b));
  
  if(ids.length === 0){
    reports.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„Ø¹Ø±Ø¶.</div>';
    return;
  }

  const allDates = Array.from(state.allDates);
  
  ids.forEach(id => {
    const card = document.createElement('div');
    card.className = 'card';
    const name = state.names[id] || `Ø§Ù„Ù…ÙˆØ¸Ù ${id}`;
    const header = document.createElement('div');
    header.innerHTML = `<h3 style="margin:0 0 6px">${escapeHtml(name)}</h3><div class="small">Ø§Ù„Ø±Ù‚Ù…: ${escapeHtml(id)} â€” ${allDates.length} ÙŠÙˆÙ…</div>`;
    card.appendChild(header);

    const wrap = document.createElement('div'); wrap.className = 'table-wrap';
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = `<tr><th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„Ø­Ø¶ÙˆØ± 1</th><th>Ø§Ù„Ø­Ø¶ÙˆØ± 2</th><th>Ø§Ù†ØµØ±Ø§Ù 1</th><th>Ø§Ù†ØµØ±Ø§Ù 2</th><th>Ø§Ù†ØµØ±Ø§Ù 3</th></tr>`;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    allDates.forEach((date, index) => {
      const times = state.grouped[id][date] || [];
      const formattedDate = formatDateDMY(date);
      const dayName = getArabicWeekday(date);
      const tr = document.createElement('tr');
      
      // ØªÙ„ÙˆÙŠÙ† ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©
      const isFriday = dayName === 'Ø§Ù„Ø¬Ù…Ø¹Ø©';
      if (isFriday) {
        tr.style.backgroundColor = 'rgba(255, 255, 0, 0.1)';
        tr.style.fontWeight = 'bold';
      }
      
      tr.innerHTML = `<td>${index + 1}</td>
                      <td>${formattedDate}</td>
                      <td>${dayName}</td>
                      <td>${escapeHtml(times[0]||'-')}</td>
                      <td>${escapeHtml(times[1]||'-')}</td>
                      <td>${escapeHtml(times[2]||'-')}</td>
                      <td>${escapeHtml(times[3]||'-')}</td>
                      <td>${escapeHtml(times[4]||'-')}</td>`;
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    wrap.appendChild(table);
    card.appendChild(wrap);
    reports.appendChild(card);
  });
}

/* Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® */
function showAllDatesTable() {
  const allDates = Array.from(state.allDates);
  if (allDates.length === 0) {
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶');
    return;
  }
  
  const container = document.getElementById('allDatesTable');
  const content = document.getElementById('datesTableContent');
  
  let html = `<div style="overflow-x:auto;">
    <table style="width:100%; border-collapse:collapse; background:white; color:#222;">
      <thead>
        <tr style="background:#f0f0f0;">
          <th style="padding:8px; border:1px solid #ddd;">Ù…Ø³Ù„Ø³Ù„</th>
          <th style="padding:8px; border:1px solid #ddd;">Ø§Ù„ØªØ§Ø±ÙŠØ® (mm/dd/yyyy)</th>
          <th style="padding:8px; border:1px solid #ddd;">Ø§Ù„ØªØ§Ø±ÙŠØ® (dd/mm/yyyy)</th>
          <th style="padding:8px; border:1px solid #ddd;">Ø§Ù„ÙŠÙˆÙ…</th>
          <th style="padding:8px; border:1px solid #ddd;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>
      </thead>
      <tbody>`;
  
  allDates.forEach((date, index) => {
    const formattedDate = formatDateDMY(date);
    const dayName = getArabicWeekday(date);
    const isFriday = dayName === 'Ø§Ù„Ø¬Ù…Ø¹Ø©';
    const notes = isFriday ? 'ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©' : '';
    
    html += `
      <tr style="${isFriday ? 'background:#fffacd; font-weight:bold;' : ''}">
        <td style="padding:6px; border:1px solid #ddd; text-align:center;">${index + 1}</td>
        <td style="padding:6px; border:1px solid #ddd; text-align:center;">${date}</td>
        <td style="padding:6px; border:1px solid #ddd; text-align:center;">${formattedDate}</td>
        <td style="padding:6px; border:1px solid #ddd; text-align:center;">${dayName}</td>
        <td style="padding:6px; border:1px solid #ddd; text-align:center;">${notes}</td>
      </tr>`;
  });
  
  html += `</tbody></table></div>`;
  content.innerHTML = html;
  container.style.display = 'block';
}

/* ØªÙ†Ø²ÙŠÙ„ CSV */
function downloadDisplayedCSV(){
  const ids = Object.keys(state.grouped).sort((a,b)=>Number(a)-Number(b));
  const allDates = Array.from(state.allDates);
  
  if(ids.length === 0) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù…ÙŠÙ„');
  
  const rows = [['ID','Name','Date','Day','Time1','Time2','Time3','Time4','Time5']];
  ids.forEach(id => {
    const name = state.names[id] || '';
    allDates.forEach(date => {
      const formattedDate = formatDateDMY(date);
      const times = state.grouped[id][date] || [];
      rows.push([id, name, formattedDate, getArabicWeekday(date), times[0]||'', times[1]||'', times[2]||'', times[3]||'', times[4]||'']);
    });
  });
  
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); 
  a.href = url; 
  a.download = `attendance_data_${new Date().toISOString().slice(0,10)}.csv`; 
  document.body.appendChild(a); 
  a.click(); 
  a.remove(); 
  URL.revokeObjectURL(url);
}

/* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© */
function printAllEmployeesStyled(){
  const ids = Object.keys(state.grouped).sort((a,b)=>Number(a)-Number(b));
  const allDates = Array.from(state.allDates);
  
  if(!ids.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
  
  const startDate = allDates[0] || '';
  const endDate = allDates[allDates.length - 1] || '';
  const formattedStartDate = formatDateDMY(startDate);
  const formattedEndDate = formatDateDMY(endDate);
  
  let html = `<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>Ø·Ø¨Ø§Ø¹Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
<style>
  body {
    font-family: 'Arial', sans-serif;
    font-size: 12px;
    line-height: 1.4;
    color: #222;
    margin: 0;
    padding: 15px;
    background: white;
  }
  
  .print-first-page {
    page-break-after: always;
  }
  
  .company-header {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #333;
  }
  
  .company-header h1 {
    margin: 0 0 5px 0;
    font-size: 22px;
    color: #000;
  }
  
  .company-header .subtitle {
    font-size: 16px;
    color: #666;
    margin-bottom: 10px;
  }
  
  .print-date {
    font-size: 12px;
    color: #555;
    text-align: left;
  }
  
  /* ÙƒØ´Ù Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ */
  .names-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 12px;
  }
  
  .names-table th,
  .names-table td {
    border: 1px solid #333;
    padding: 6px 8px;
    text-align: center;
  }
  
  .names-table th {
    background-color: #f0f0f0;
    font-weight: bold;
  }
  
  .names-table tbody tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  
  /* ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù */
  .employee-section {
    page-break-after: always;
    margin-top: 20px;
    padding-top: 20px;
  }
  
  .employee-card {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 20px;
  }
  
  .employee-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #ccc;
  }
  
  .employee-info {
    flex: 1;
  }
  
  .employee-name {
    font-size: 18px;
    font-weight: bold;
    margin: 0 0 8px 0;
    color: #000;
  }
  
  .employee-id {
    font-size: 14px;
    color: #555;
    margin: 0;
  }
  
  .employee-meta {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 15px;
  }
  
  .meta-item {
    background: white;
    border: 1px solid #eee;
    padding: 10px;
    border-radius: 4px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .meta-label {
    font-size: 11px;
    color: #666;
    margin-bottom: 5px;
    font-weight: bold;
  }
  
  .meta-value {
    font-size: 13px;
    font-weight: bold;
    color: #333;
  }
  
  /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± */
  .attendance-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 11px;
  }
  
  .attendance-table th,
  .attendance-table td {
    border: 1px solid #333;
    padding: 5px 6px;
    text-align: center;
  }
  
  .attendance-table thead th {
    background-color: #e9ecef;
    font-weight: bold;
    color: #212529;
    font-size: 12px;
  }
  
  .attendance-table tbody tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  
  /* ØªÙ„ÙˆÙŠÙ† ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø© */
  .friday-row {
    background-color: #fffacd !important;
    font-weight: bold;
  }
  
  /* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙØ­Ø© */
  .page-info {
    font-size: 11px;
    color: #666;
    text-align: left;
    margin-top: 10px;
    border-top: 1px solid #ddd;
    padding-top: 8px;
  }
  
  /* Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨Ø© */
  @media print {
    .no-print {
      display: none !important;
    }
  }
  
  @page {
    margin: 15mm;
    size: A4;
  }
</style>
</head>
<body>`;

  // === Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: ÙƒØ´Ù Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ===
  html += `
  <div class="print-first-page">
    <div class="company-header">
      <h1>Ø´Ø±ÙƒØ© Ø±ÙŠØ§Ù† Ø§Ù„Ø¬ÙˆØ±</h1>
      <div class="subtitle">ÙƒØ´Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        <div class="print-date">
          ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString('ar-SA')}<br>
          ÙˆÙ‚Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleTimeString('ar-SA')}
        </div>
        <div style="font-size: 13px; color: #555; background:#f8f9fa; padding:10px; border-radius:5px;">
          <strong>Ø§Ù„ÙØªØ±Ø©:</strong> Ù…Ù† ${formattedStartDate} Ø¥Ù„Ù‰ ${formattedEndDate}<br>
          <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙŠØ§Ù…:</strong> ${allDates.length} ÙŠÙˆÙ…<br>
          <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:</strong> ${ids.length} Ù…ÙˆØ¸Ù
        </div>
      </div>
    </div>
    
    <h2 style="text-align: center; margin: 25px 0 15px; font-size: 18px; border-bottom:2px solid #333; padding-bottom:10px;">ÙƒØ´Ù Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
    
    <table class="names-table">
      <thead>
        <tr>
          <th width="8%">Ù…Ø³Ù„Ø³Ù„</th>
          <th width="62%">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
          <th width="15%">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
          <th width="15%">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</th>
        </tr>
      </thead>
      <tbody>`;
  
  ids.forEach((id, idx) => {
    const name = state.names[id] || id;
    const attendanceDays = Object.keys(state.grouped[id] || {}).length;
    html += `
        <tr>
          <td>${idx + 1}</td>
          <td style="text-align: right; padding-right: 20px; font-weight:bold;">${escapeHtml(name)}</td>
          <td style="font-weight:bold;">${escapeHtml(id)}</td>
          <td>${attendanceDays}</td>
        </tr>`;
  });
  
  html += `
      </tbody>
    </table>
    
    <div style="margin-top: 30px; padding: 15px; background: #f0f0f0; border-radius: 5px; font-size: 12px; border-right:4px solid #06b6d4;">
      <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong><br>
      1. ØªÙ… Ø±ØµØ¯ ${ids.length} Ù…ÙˆØ¸Ù Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø© Ù…Ù† ${formattedStartDate} Ø¥Ù„Ù‰ ${formattedEndDate}<br>
      2. Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„: ${allDates.length} ÙŠÙˆÙ…<br>
      3. ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø© Ù…Ø¸Ù„Ù„ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙØ± ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    </div>
  </div>`;

  // === ØµÙØ­Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ÙØ±Ø¯ÙŠØ© ===
  ids.forEach((id, employeeIndex) => {
    const name = state.names[id] || id;
    const attendanceDays = Object.keys(state.grouped[id] || {}).length;
    
    html += `
    <div class="employee-section">
      <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¹Ù„ÙˆÙŠØ© -->
      <div class="employee-card">
        <div class="employee-header">
          <div class="employee-info">
            <h2 class="employee-name">${escapeHtml(name)}</h2>
            <p class="employee-id">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ: ${escapeHtml(id)}</p>
          </div>
          <div style="text-align: left; background:#e9ecef; padding:8px; border-radius:4px;">
            <div style="font-size: 12px; color: #555;">
              <strong>ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù:</strong> ${employeeIndex + 1} Ù…Ù† ${ids.length}<br>
              <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</strong> ${new Date().toLocaleDateString('ar-SA')}
            </div>
          </div>
        </div>
        
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø­ØµØ§Ø¦ÙŠØ© -->
        <div class="employee-meta">
          <div class="meta-item">
            <div class="meta-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</div>
            <div class="meta-value">${attendanceDays} ÙŠÙˆÙ…</div>
          </div>
          <div class="meta-item">
            <div class="meta-label">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</div>
            <div class="meta-value">${formattedStartDate}<br>Ø¥Ù„Ù‰<br>${formattedEndDate}</div>
          </div>
          <div class="meta-item">
            <div class="meta-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
            <div class="meta-value">${allDates.length} ÙŠÙˆÙ…</div>
          </div>
        </div>
      </div>
      
      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
      <h3 style="text-align: center; margin: 20px 0 15px; font-size: 16px; color:#333; background:#f8f9fa; padding:10px; border-radius:5px;">
        ØªÙØµÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
      </h3>
      
      <table class="attendance-table">
        <thead>
          <tr class="table-header">
            <th width="6%">Ù…</th>
            <th width="18%">Ø§Ù„ØªØ§Ø±ÙŠØ®<br>(dd/mm/yyyy)</th>
            <th width="14%">Ø§Ù„ÙŠÙˆÙ…</th>
            <th width="12%">Ø§Ù„Ø­Ø¶ÙˆØ± 1</th>
            <th width="12%">Ø§Ù„Ø­Ø¶ÙˆØ± 2</th>
            <th width="12%">Ø§Ù†ØµØ±Ø§Ù 1</th>
            <th width="12%">Ø§Ù†ØµØ±Ø§Ù 2</th>
            <th width="12%">Ø§Ù†ØµØ±Ø§Ù 3</th>
          </tr>
        </thead>
        <tbody>`;
    
    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±
    allDates.forEach((date, index) => {
      const times = state.grouped[id][date] || [];
      const formattedDate = formatDateDMY(date);
      const dayName = getArabicWeekday(date);
      const isFriday = dayName === 'Ø§Ù„Ø¬Ù…Ø¹Ø©';
      const rowClass = isFriday ? 'class="friday-row"' : '';
      
      html += `
          <tr ${rowClass}>
            <td>${index + 1}</td>
            <td>${formattedDate}</td>
            <td>${dayName}</td>
            <td>${escapeHtml(times[0] || '-')}</td>
            <td>${escapeHtml(times[1] || '-')}</td>
            <td>${escapeHtml(times[2] || '-')}</td>
            <td>${escapeHtml(times[3] || '-')}</td>
            <td>${escapeHtml(times[4] || '-')}</td>
          </tr>`;
    });
    
    html += `
        </tbody>
      </table>
      
      <div class="page-info">
        <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙØ­Ø©:</strong> Ø§Ù„Ù…ÙˆØ¸Ù: ${escapeHtml(name)} | Ø§Ù„Ø±Ù‚Ù…: ${escapeHtml(id)} | 
        ØµÙØ­Ø©: ${employeeIndex + 1} Ù…Ù† ${ids.length} | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±: ${attendanceDays} ÙŠÙˆÙ…
      </div>
    </div>`;
  });

  html += `
  <script>
    window.onload = function() {
      // Ø¥Ø¹Ø·Ø§Ø¡ ÙˆÙ‚Øª Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø«Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
      setTimeout(function() {
        window.print();
        setTimeout(function() {
          window.close();
        }, 1000);
      }, 500);
    }
  <\/script>
</body>
</html>`;

  const w = window.open('', '_blank', 'width=1200,height=800');
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© */
function escapeHtml(s){ 
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); 
}
</script>
</body>
</html>
