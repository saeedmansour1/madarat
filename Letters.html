<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بحث خطابات الدفاع المدني - مجمع أبراج الصفوة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            direction: rtl;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2c3e50;
        }
        
        .header h1 {
            font-size: 28px;
            color: #2c3e50;
            margin: 10px 0 5px;
        }
        
        .header p {
            color: #7f8c8d;
        }
        
        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-form input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .btn-primary {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary:hover {
            background: #1e2a36;
        }
        
        .search-results {
            margin-top: 20px;
        }
        
        .result-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .result-item h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            display: flex;
            gap: 10px;
        }
        
        .detail-label {
            font-weight: bold;
            color: #2c3e50;
            min-width: 100px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-info {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-info:hover {
            background: #2980b9;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 18px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #3498db;
        }
        
        .back-button {
            margin-bottom: 20px;
        }
        
        .letter-preview {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .preview-content {
            background: white;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            width: 21cm;
            min-height: 29.7cm;
            margin: 0 auto;
            font-size: 16px;
            line-height: 1.6;
            position: relative;
        }
        
        .preview-header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-logo {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .preview-logo img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .preview-qr {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .preview-qr img {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: auto;
        }
        
        .preview-header h2 {
            font-size: 22px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .info-table td {
            padding: 8px 5px;
            vertical-align: top;
        }
        
        .info-table .label {
            font-weight: bold;
            white-space: nowrap;
            width: 100px;
        }
        
        .letter-body {
            line-height: 1.8;
            margin-bottom: 30px;
            text-align: justify;
        }
        
        .signature-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            font-size: 14px;
        }
        
        .signature-table th, .signature-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        .signature-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .signature-img {
            max-height: 60px;
            max-width: 150px;
        }
        
        .stamp-container {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
        }
        
        .stamp-image {
            max-width: 120px;
            max-height: 120px;
        }
        
        .preview-actions {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .loading-pdf {
            display: none;
            text-align: center;
            padding: 20px;
            color: #3498db;
        }
        
        .tenant-data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border: 1px solid #ddd;
        }
        
        .tenant-data-table th {
            background-color: #27ae60;
            color: white;
            padding: 12px 15px;
            text-align: right;
            border: 1px solid #ddd;
        }
        
        .tenant-data-table td {
            padding: 10px 15px;
            border: 1px solid #ddd;
        }
        
        .tenant-data-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .tenant-data-header {
            background-color: #27ae60;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border-radius: 5px 5px 0 0;
        }
        
        @media (max-width: 900px) {
            .search-form {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .preview-content {
                width: 100%;
                min-height: auto;
            }
            
            .preview-actions {
                flex-direction: column;
            }
            
            .preview-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .tenant-data-table {
                font-size: 14px;
            }
        }
        
        @media print {
            body, html {
                height: auto;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            body * {
                visibility: hidden;
            }
            
            .container, .container * {
                visibility: hidden;
                display: none !important;
            }
            
            .letter-preview, .letter-preview * {
                display: block !important;
                visibility: visible !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            .preview-content, .preview-content * {
                visibility: visible;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 15px !important;
                box-shadow: none !important;
                position: static !important;
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .preview-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                width: 100% !important;
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .preview-logo, .preview-qr {
                display: flex !important;
                visibility: visible !important;
                width: 60px !important;
                height: 60px !important;
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .preview-actions, .back-button, .search-section, .header,
            .preview-actions *, .back-button *, .search-section *, .header * {
                display: none !important;
                visibility: hidden !important;
            }
            
            .preview-content {
                page-break-before: avoid;
                page-break-after: avoid;
                page-break-inside: avoid;
            }
            
            .preview-header, .info-table, .tenant-data-header, 
            .tenant-data-table, .letter-body, .signature-table {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .preview-content {
                font-size: 14px !important;
                line-height: 1.4 !important;
            }
            
            .preview-header h2 {
                font-size: 20px !important;
            }
            
            @page {
                margin: 0.5cm !important;
                size: portrait;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-button">
            <button class="btn-info" onclick="window.location.href='index.html'">
                <i class="fas fa-arrow-right"></i> العودة للصفحة الرئيسية
            </button>
        </div>
        
        <div class="header">
            <h1>بحث خطابات الدفاع المدني</h1>
            <p>مجمع أبراج الصفوة - إدارة السلامة</p>
        </div>
        
        <div class="search-section">
            <h2><i class="fas fa-search"></i> البحث عن خطاب</h2>
            <div class="search-form">
                <input type="text" id="searchInput" placeholder="أدخل رقم المحل للبحث">
                <button class="btn-primary" onclick="searchLetter()">
                    <i class="fas fa-search"></i> بحث
                </button>
            </div>
            
            <div id="searchResults" class="search-results">
                <!-- سيتم عرض نتائج البحث هنا -->
            </div>
        </div>
        
        <div id="letterPreview" class="letter-preview">
            <div class="preview-content" id="previewContent">
                <!-- سيتم عرض محتوى الخطاب هنا -->
            </div>
            
            <div class="preview-actions" id="previewActions" style="display: none;">
                <button class="btn-warning" onclick="printLetter()">
                    <i class="fas fa-print"></i> طباعة الخطاب
                </button>
                <button class="btn-success" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i> تصدير PDF
                </button>
                <button class="btn-info" onclick="closePreview()">
                    <i class="fas fa-times"></i> إغلاق المعاينة
                </button>
            </div>
        </div>
        
        <div id="loadingPDF" class="loading-pdf">
            <i class="fas fa-spinner fa-spin"></i> جاري تحضير ملف PDF...
        </div>
    </div>

    <script>
        // مسارات الصور الثابتة على GitHub
        const STATIC_SIGNATURES = {
            rentalSignature: "https://raw.githubusercontent.com/saeedmansour1/madarat/main/signatures/rental.png",
            safetySignature: "https://raw.githubusercontent.com/saeedmansour1/madarat/main/signatures/safety.png", 
            engineeringSignature: "https://raw.githubusercontent.com/saeedmansour1/madarat/main/signatures/engineering.png",
            institutionSignature: "https://raw.githubusercontent.com/saeedmansour1/madarat/main/signatures/institution.png",
            stamp: "https://raw.githubusercontent.com/saeedmansour1/madarat/main/signatures/stamp.png",
            logo: "https://raw.githubusercontent.com/saeedmansour1/madarat/main/signatures/logo.png",
            qrCode: "https://raw.githubusercontent.com/saeedmansour1/madarat/main/signatures/qr-code.png"
        };
        
        // رابط API لجلب البيانات من استضافة Award
        const API_BASE_URL = "https://elsafwa.onlinewebshop.net/tel/api.php";
        
        // دالة البحث عن الخطاب
        function searchLetter() {
            const shopNumber = document.getElementById('searchInput').value.trim();
            
            if (shopNumber === '') {
                alert('يرجى إدخال رقم المحل للبحث');
                return;
            }
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> جاري البحث...</div>';
            
            // جلب البيانات من API
            fetch(`${API_BASE_URL}/letters?shop=${encodeURIComponent(shopNumber)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('خطأ في جلب البيانات');
                }
                return response.json();
            })
            .then(data => {
                if (data && data.length > 0) {
                    const formData = data[0];
                    
                    resultsDiv.innerHTML = `
                        <div class="result-item">
                            <h3>نتائج البحث عن المحل رقم: ${shopNumber}</h3>
                            <div class="result-details">
                                <div class="detail-item">
                                    <span class="detail-label">اسم المستأجر:</span>
                                    <span>${formData.tenant || 'غير محدد'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">رقم الخطاب:</span>
                                    <span>${formData.number || 'غير محدد'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">التاريخ:</span>
                                    <span>${formData.date || 'غير محدد'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">الدور:</span>
                                    <span>${formData.floor || 'غير محدد'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">المساحة:</span>
                                    <span>${formData.area || 'غير محدد'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">النشاط:</span>
                                    <span>${formData.activity || 'غير محدد'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">المكتب الهندسي:</span>
                                    <span>${formData.engineering_office || 'غير محدد'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">مؤسسة السلامة:</span>
                                    <span>${formData.safety_institution || 'غير محدد'}</span>
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn-success" onclick="viewLetter('${shopNumber}')">
                                    <i class="fas fa-eye"></i> عرض الخطاب
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-search"></i>
                            <p>لا توجد نتائج للبحث عن المحل رقم: ${shopNumber}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>حدث خطأ في الاتصال بالخادم</p>
                    </div>
                `;
                console.error('Error:', error);
            });
        }
        
        // دالة عرض الخطاب
        function viewLetter(shopNumber) {
            const previewDiv = document.getElementById('letterPreview');
            const previewContent = document.getElementById('previewContent');
            const previewActions = document.getElementById('previewActions');
            
            previewContent.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> جاري تحميل الخطاب...</div>';
            previewDiv.style.display = 'block';
            previewActions.style.display = 'none';
            
            // جلب البيانات من API
            fetch(`${API_BASE_URL}/letters?shop=${encodeURIComponent(shopNumber)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('خطأ في جلب البيانات');
                }
                return response.json();
            })
            .then(data => {
                if (data && data.length > 0) {
                    const formData = data[0];
                    
                    // استخدام المسارات الثابتة للصور
                    const logoPath = STATIC_SIGNATURES.logo;
                    const rentalSignaturePath = STATIC_SIGNATURES.rentalSignature;
                    const safetySignaturePath = STATIC_SIGNATURES.safetySignature;
                    const engineeringSignaturePath = STATIC_SIGNATURES.engineeringSignature;
                    const institutionSignaturePath = STATIC_SIGNATURES.institutionSignature;
                    const stampPath = STATIC_SIGNATURES.stamp;
                    const qrCodePath = STATIC_SIGNATURES.qrCode;
                    
                    previewContent.innerHTML = `
                        <div class="preview-header">
                            ${logoPath ? `
                                <div class="preview-logo">
                                    <img src="${logoPath}" alt="لوجو الشركة" onload="checkAllImagesLoaded()">
                                </div>
                            ` : '<div class="preview-logo"></div>'}
                            
                            ${qrCodePath ? `
                                <div class="preview-qr">
                                    <img src="${qrCodePath}" alt="QR Code" onload="checkAllImagesLoaded()">
                                </div>
                            ` : '<div class="preview-qr"></div>'}
                        </div>
                        
                        <table class="info-table">
                            <tr>
                                <td class="label">التاريخ:</td>
                                <td>${formData.date || ''}</td>
                                <td class="label">رقم الخطاب:</td>
                                <td>${formData.number || ''}</td>
                            </tr>
                        </table>
                        
                        <p>سعادة مدير الإدارة العامة للدفاع المدنى بالعاصمة المقدسة</p>
                        <p>سعادة مدير مركز السلامة الميدانى بالمنطقة المركزية</p>
                        <p>الموضوع: بشأن الوقوف على المحل الموضح بياناته أدناه</p>
                        
                        <!-- جدول بيانات المستأجر -->
                        <div style="margin: 20px 0;">
                            <div class="tenant-data-header">بيانات المحل والمستأجر</div>
                            <table class="tenant-data-table">
                                <tr>
                                    <th>اسم المستأجر</th>
                                    <td>${formData.tenant || ''}</td>
                                    <th>رقم المحل</th>
                                    <td>${formData.shop || ''}</td>
                                </tr>
                                <tr>
                                    <th>الدور</th>
                                    <td>${formData.floor || ''}</td>
                                    <th>المساحة</th>
                                    <td>${formData.area || ''} م²</td>
                                </tr>
                                <tr>
                                    <th>النشاط</th>
                                    <td>${formData.activity || ''}</td>
                                    <th>المكتب الهندسي</th>
                                    <td>${formData.engineering_office || ''}</td>
                                </tr>
                                <tr>
                                    <th>مؤسسة السلامة</th>
                                    <td colspan="3">${formData.safety_institution || ''}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="letter-body">
                            <p>نفيدكم نحن إدارة السلامة الصادرة بموجب قرار سمو وزير الداخلية رقم (10/ك/و/دف) وتاريخ 24/04/1410هـ</p>
                            <p>بأنه تم الوقوف على المحل وانه مستوفى لاشتراطات ومتطلبات السلامة ومطابق للمخططات المعتمدة من المكتب الهندسى ولايوجد به أي استحداثات أنه ضمن خطة التأجير المعتمدة للسوق التجارى واتضح جاهزية جميع أنظمة الوقاية والحماية من الحريق.</p>
                            <p>وتقبلوا وافر الاحترام والتقدير</p>
                        </div>
                        
                        <table class="signature-table">
                            <tr>
                                <th>الجهة</th>
                                <th>الاسم</th>
                                <th>التوقيع</th>
                            </tr>
                            <tr>
                                <td>إدارة التأجير</td>
                                <td>حسن جمعان الزهرانى</td>
                                <td>${rentalSignaturePath ? `<img src="${rentalSignaturePath}" class="signature-img" alt="توقيع إدارة التأجير" onload="checkAllImagesLoaded()">` : ''}</td>
                            </tr>
                            <tr>
                                <td>إدارة السلامة</td>
                                <td>تركى هباس العتيبى</td>
                                <td>${safetySignaturePath ? `<img src="${safetySignaturePath}" class="signature-img" alt="توقيع إدارة السلامة" onload="checkAllImagesLoaded()">` : ''}</td>
                            </tr>
                            <tr>
                                <td>المكتب الهندسى</td>
                                <td>شركة طلاقى للاستشارات</td>
                                <td>${engineeringSignaturePath ? `<img src="${engineeringSignaturePath}" class="signature-img" alt="توقيع المكتب الهندسي" onload="checkAllImagesLoaded()">` : ''}</td>
                            </tr>
                            <tr>
                                <td>مؤسسة السلامة</td>
                                <td> العطيشان</td>
                                <td>${institutionSignaturePath ? `<img src="${institutionSignaturePath}" class="signature-img" alt="توقيع مؤسسة السلامة" onload="checkAllImagesLoaded()">` : ''}</td>
                            </tr>
                        </table>
                        <div style="text-align: center;">
                            <p>إدارة مجمع أبراج الصفوة</p>
                        </div>
                        ${stampPath ? `
                            <div class="stamp-container">
                                <img src="${stampPath}" class="stamp-image" alt="ختم الشركة" onload="checkAllImagesLoaded()">
                            </div>
                        ` : ''}
                    `;
                    
                    // بدء عدادات تحميل الصور
                    window.imagesLoaded = 0;
                    window.totalImages = document.querySelectorAll('#previewContent img').length;
                    
                    // إظهار أزرار الإجراءات بعد تحميل المحتوى
                    previewActions.style.display = 'flex';
                } else {
                    previewContent.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>لا توجد بيانات للعرض</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                previewContent.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>حدث خطأ في تحميل البيانات</p>
                    </div>
                `;
                console.error('Error:', error);
            });
        }
        
        // التحقق من تحميل جميع الصور
        function checkAllImagesLoaded() {
            if (window.totalImages === undefined) return;
            
            window.imagesLoaded++;
            if (window.imagesLoaded >= window.totalImages) {
                console.log('تم تحميل جميع الصور بنجاح');
            }
        }
        
        // دالة طباعة الخطاب
        function printLetter() {
            const previewContent = document.getElementById('previewContent');
            if (!previewContent) {
                alert("لا يوجد محتوى للطباعة");
                return;
            }

            // إنشاء نافذة طباعة
            const printWindow = window.open('', '_blank');
            
            // محتوى HTML للطباعة
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>طباعة خطاب الدفاع المدني</title>
                    <style>
                        body {
                            direction: rtl;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            margin: 0.5;
                            padding: 15mm;
                            font-size: 14px;
                            line-height: 1.4;
                        }
                        
                        .preview-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 20px;
                        }
                        .preview-logo, .preview-qr {
                            width: 60px;
                            height: 60px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            overflow: hidden;
                        }
                        .preview-logo img, .preview-qr img {
                            max-width: 100%;
                            max-height: 100%;
                        }
                        .preview-header h2 {
                            font-size: 20px;
                            color: #2c3e50;
                            margin: 0;
                        }
                        .tenant-data-header {
                            text-align: center;
                            font-weight: bold;
                            margin-bottom: 10px;
                            font-size: 16px;
                        }
                        .info-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                        }
                        .info-table td {
                            padding: 5px;
                        }
                        .info-table .label {
                            font-weight: bold;
                            white-space: nowrap;
                            width: 80px;
                        }
                        .tenant-data-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                            border: 1px solid #ddd;
                        }
                        .tenant-data-table th {
                            background-color: #27ae60;
                            color: white;
                            padding: 8px 10px;
                            text-align: right;
                            border: 1px solid #ddd;
                        }
                        .tenant-data-table td {
                            padding: 8px 10px;
                            border: 1px solid #ddd;
                        }
                        .letter-body {
                            line-height: 1.8;
                            margin-bottom: 20px;
                            text-align: justify;
                        }
                        .signature-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 30px;
                            font-size: 12px;
                        }
                        .signature-table th, .signature-table td {
                            border: 1px solid #ddd;
                            padding: 5px;
                            text-align: center;
                        }
                        .signature-table th {
                            background-color: #f2f2f2;
                            font-weight: bold;
                        }
                        .signature-img {
                            max-height: 60px;
                            max-width: 120px;
                        }
                        .stamp-container {
                            text-align: center;
                            margin-top: 20px;
                            padding-top: 15px;
                            border-top: 1px dashed #ccc;
                        }
                        .stamp-image {
                            max-width: 100px;
                            max-height: 100px;
                        }
                        @media print {
                            @page {
                                margin: 15mm;
                                size: portrait;
                            }
                            body {
                                padding: 0;
                            }
                        }
                    </style>
                </head>
                <body onload="window.print(); window.onafterprint = function() { window.close(); }">
                    ${previewContent.innerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
        }
        
        // دالة تصدير PDF
        function exportToPDF() {
  const content = document.getElementById('previewContent');
  const loadingPDF = document.getElementById('loadingPDF');
  
  loadingPDF.style.display = 'block';

  // قبل ما نعمل PDF، نصغر المحتوى شوية عشان يدخل في صفحة وحدة
  content.style.width = '800px'; // مقاس مناسب لـ A4
  content.style.margin = 'auto';

  const opt = {
    margin:       10, // هوامش الصفحة بالمليمتر
    filename:     'خطاب_الدفاع_المدني.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS: true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak:    { mode: ['avoid-all','css','legacy'] } // يمنع القص العشوائي
  };

  html2pdf()
    .set(opt)
    .from(content)
    .save()
    .then(() => {
      loadingPDF.style.display = 'none';
      // رجّع العرض الطبيعي بعد الحفظ
      content.style.width = '';
      content.style.margin = '';
    })
    .catch(err => {
      loadingPDF.style.display = 'none';
      console.error('Error generating PDF:', err);
    });
}
        
        // دالة إغلاق معاينة الخطاب
        function closePreview() {
            document.getElementById('letterPreview').style.display = 'none';
        }
        
        // السماح بالبحث بالزر Enter
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchLetter();
            }
        });
    </script>
</body>

</html>

